<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon üêâ - Registre de Paquets</title>
    
    <!-- CDN de Pico.css (notre base) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <!-- CDN de Vue.js -->
    <script src="https://unpkg.com/vue@3"></script>

    <!-- NOTRE CSS PERSONNALIS√â -->
    <style>
        /* --- Th√®me & Palette "Dragon" --- */
        :root {
            --pico-font-family: 'Inter', -apple-system, system-ui, sans-serif;
            --pico-font-size: 100%;
            --pico-primary: #7e57c2; /* Un violet comme couleur d'accent */
            --pico-primary-hover: #673ab7;
            --pico-primary-focus: rgba(126, 87, 194, 0.25);
            --pico-card-background-color: #1e2025;
            --pico-card-border-color: #2d3038;
        }

        body {
            background-color: #14161a;
        }

        /* --- Mise en Page & Composants --- */
        .hero {
            text-align: center;
            padding: 2rem 0;
        }
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .hero p {
            font-size: 1.1rem;
            color: var(--pico-muted-color);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--pico-card-border-color);
            padding-bottom: 1rem;
        }
        
        .package-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .package-card {
            border: 1px solid var(--pico-card-border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .form-container {
            max-width: 450px;
            margin: 2rem auto;
        }
        
        .alert {
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            margin-top: 1rem;
        }
        .alert-error {
            background-color: rgba(217, 83, 79, 0.1);
            border: 1px solid #d9534f;
            color: #d9534f;
        }
        .alert-success {
             background-color: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            color: #28a745;
        }

        .api-key-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: #14161a;
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            word-break: break-all;
            margin-top: 1rem;
        }
        .api-key-wrapper code {
            flex-grow: 1;
        }
        
        /* --- Loader Anim√© --- */
        .loader {
            display: block;
            margin: 3rem auto;
            border: 4px solid var(--pico-muted-border-color);
            border-top: 4px solid var(--pico-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="app" class="container">
        
        <nav>
            <ul><li><strong>Dragon üêâ Registry</strong></li></ul>
            <ul>
                <li><a href="#" @click.prevent="changeView('explore')">Explorer</a></li>
                <li v-if="!isLoggedIn"><a href="#" role="button" class="contrast" @click.prevent="changeView('login')">Connexion</a></li>
                <li v-if="!isLoggedIn"><a href="#" role="button" @click.prevent="changeView('register')">S'inscrire</a></li>
                <li v-if="isLoggedIn"><a href="#" @click.prevent="changeView('profile')">Mon Profil</a></li>
                <li v-if="isLoggedIn"><a href="#" @click.prevent="logout">D√©connexion</a></li>
            </ul>
        </nav>

        <main>
            <!-- ==================== Vue d'Exploration et Recherche ==================== -->
            <section v-if="currentView === 'explore'">
                <div class="hero">
                    <h1>Le Registre de Paquets du Dragon</h1>
                    <p>D√©couvrez, publiez et g√©rez vos paquets en toute simplicit√©.</p>
                </div>
                <input type="search" v-model="searchTerm" @input="searchPackages" placeholder="Rechercher un paquet...">
                
                <div v-if="isLoading" class="loader"></div>
                <div v-if="!isLoading && packages.length === 0" style="text-align: center; margin-top: 2rem;">Aucun paquet trouv√©.</div>

                <div v-if="!isLoading" class="package-grid">
                    <article v-for="pkg in packages" :key="pkg.package_name + pkg.version" class="package-card">
                        <header>
                            <strong>{{ pkg.package_name }}</strong> @ <small>{{ pkg.version }}</small>
                        </header>
                        <p>{{ pkg.description || 'Aucune description' }}</p>
                        <footer><small>Par : <em>{{ pkg.author }}</em></small></footer>
                    </article>
                </div>
            </section>

            <!-- ==================== Vue de Connexion / Inscription ==================== -->
            <section v-if="currentView === 'login' || currentView === 'register'">
                <article class="form-container">
                    <hgroup>
                        <h1 v-if="currentView === 'login'">Connexion</h1>
                        <h1 v-if="currentView === 'register'">Inscription</h1>
                        <h2 v-if="currentView === 'login'">Acc√©dez √† votre compte Dragon.</h2>
                        <h2 v-if="currentView === 'register'">Cr√©ez un nouveau compte Dragon.</h2>
                    </hgroup>
                    
                    <form @submit.prevent="currentView === 'login' ? login() : register()">
                        <input v-if="currentView === 'register'" type="text" v-model="registerForm.username" placeholder="Nom d'utilisateur" required>
                        <input type="email" v-model="form.email" placeholder="Email" required>
                        <input type="password" v-model="form.password" placeholder="Mot de passe" required>
                        
                        <button type="submit" :aria-busy="isLoading">
                            <span v-if="currentView === 'login'">Se connecter</span>
                            <span v-if="currentView === 'register'">S'inscrire</span>
                        </button>

                        <div v-if="error" class="alert alert-error">{{ error }}</div>
                        <div v-if="successMessage" class="alert alert-success">{{ successMessage }}</div>
                    </form>
                </article>
            </section>

            <!-- ==================== Vue du Profil Utilisateur ==================== -->
            <section v-if="currentView === 'profile'">
                <h1>Mon Profil</h1>
                <h3>Mes paquets publi√©s</h3>
                <div v-if="isLoading" class="loader"></div>
                <div v-if="!isLoading && userPackages.length === 0">Vous n'avez publi√© aucun paquet.</div>
                <ul>
                    <li v-for="pkg in userPackages">{{ pkg.package_name }} @ {{ pkg.version }}</li>
                </ul>
                <hr>
                <h3>Votre Cl√© API</h3>
                <p>Utilisez cette cl√© pour publier des paquets depuis votre CLI.</p>
                <button @click="generateApiKey" :aria-busy="isLoading">G√©n√©rer une nouvelle cl√© API</button>
                <div v-if="apiKey" class="api-key-wrapper">
                    <code>{{ apiKey }}</code>
                    <button @click="copyApiKey" class="secondary outline" style="min-width: 100px;">
                        <svg v-if="copyButtonText === 'Copier'" xmlns="http://www.w3.org/2000/svg" height="16" width="14" viewBox="0 0 448 512" style="fill: currentColor; vertical-align: middle;"><path d="M208 0H332.1c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9V368c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V48c0-26.5 21.5-48 48-48zM48 128h80v64H64V448H256V416h64v48c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V176c0-26.5 21.5-48 48-48z"/></svg>
                        {{ copyButtonText }}
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Le code de l'application Vue.js -->
    <script>
        const API_URL = "https://sarver-fullstack-4.onrender.com";

        const app = Vue.createApp({
            data() {
                return {
                    currentView: 'explore', isLoading: false, error: null, successMessage: null,
                    packages: [], searchTerm: '',
                    isLoggedIn: false, token: null,
                    form: { email: '', password: '' },
                    registerForm: { username: '', email: '', password: '' },
                    userPackages: [], apiKey: null, copyButtonText: 'Copier',
                }
            },
            methods: {
                changeView(view) {
                    this.currentView = view;
                    this.error = null; this.successMessage = null;
                    this.form = { email: '', password: '' }; // Reset form
                },
                async fetchExplorePackages() { /* ... (code inchang√©) ... */ },
                async searchPackages() { /* ... (code inchang√©) ... */ },
                async register() {
                    this.isLoading = true; this.error = null; this.successMessage = null;
                    try {
                        const payload = { ...this.registerForm, email: this.form.email, password: this.form.password };
                        const response = await fetch(`${API_URL}/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error);
                        this.successMessage = "Inscription r√©ussie ! Vous pouvez maintenant vous connecter.";
                        this.registerForm = { username: ''}; this.form = { email: '', password: '' };
                    } catch (e) { this.error = e.message; } finally { this.isLoading = false; }
                },
                async login() {
                    this.isLoading = true; this.error = null;
                    try {
                        const response = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.form) });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || "Email ou mot de passe invalide.");
                        this.token = data.token;
                        this.isLoggedIn = true;
                        localStorage.setItem('dragon_token', this.token);
                        this.changeView('profile');
                        this.fetchUserPackages();
                    } catch (e) { this.error = e.message; } finally { this.isLoading = false; }
                },
                logout() { /* ... (code inchang√©) ... */ },
                async fetchUserPackages() { /* ... (code inchang√©) ... */ },
                async generateApiKey() { /* ... (code inchang√©) ... */ },
                copyApiKey() {
                    navigator.clipboard.writeText(this.apiKey).then(() => {
                        this.copyButtonText = 'Copi√© !';
                        setTimeout(() => { this.copyButtonText = 'Copier'; }, 2000);
                    });
                }
            },
            mounted() {
                // ... (code inchang√©, mais on peut le simplifier si besoin)
                this.fetchExplorePackages();
                const savedToken = localStorage.getItem('dragon_token');
                if (savedToken) {
                    this.token = savedToken;
                    this.isLoggedIn = true;
                }
            }
        });
        
        // J'ai recopi√© le code JS pour la clart√©, mais seules les lignes touchant aux formulaires et le 'copyApiKey' ont vraiment chang√©.
        const methods = app.config.globalProperties;
        app.config.globalProperties.fetchExplorePackages = async function() { this.isLoading = true; try { const r = await fetch(`${API_URL}/packages/explore`); this.packages = await r.json(); } catch (e) { this.error = "Impossible de charger les paquets."; } finally { this.isLoading = false; }};
        app.config.globalProperties.searchPackages = async function() { if (this.searchTerm.trim() === '') { this.fetchExplorePackages(); return; } this.isLoading = true; try { const r = await fetch(`${API_URL}/packages/search?q=${this.searchTerm}`); this.packages = await r.json(); } catch (e) { this.error = "La recherche a √©chou√©."; } finally { this.isLoading = false; }};
        app.config.globalProperties.logout = function() { this.token = null; this.isLoggedIn = false; localStorage.removeItem('dragon_token'); this.changeView('explore'); };
        app.config.globalProperties.fetchUserPackages = async function() { if (!this.token) return; this.isLoading = true; try { const r = await fetch(`${API_URL}/user/packages`, { headers: { 'Authorization': `Bearer ${this.token}` } }); this.userPackages = await r.json(); } catch (e) { this.error = "Impossible de charger vos paquets."; } finally { this.isLoading = false; }};
        app.config.globalProperties.generateApiKey = async function() { if (!this.token) return; this.isLoading = true; try { const r = await fetch(`${API_URL}/user/api-token`, { method: 'POST', headers: { 'Authorization': `Bearer ${this.token}` } }); const data = await r.json(); this.apiKey = data.api_token; } catch (e) { this.error = "Impossible de g√©n√©rer la cl√© API."; } finally { this.isLoading = false; }};

        app.mount('#app');
    </script>

</body>
</html>
