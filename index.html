<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon üêâ - Registre de Paquets</title>
    <!-- 1. CDN de Pico.css pour un style simple et propre -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- 2. CDN de Vue.js pour la r√©activit√© -->
    <script src="https://unpkg.com/vue@3"></script>
    <style>
        :root { --pico-font-size: 100%; }
        nav { display: flex; justify-content: space-between; align-items: center; }
        .grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .error { color: var(--pico-color-red-400); }
        .api-key { background-color: var(--pico-card-background-color); padding: 1rem; border-radius: var(--pico-border-radius); word-break: break-all; margin-top: 1rem; }
    </style>
</head>
<body>

    <div id="app" class="container">
        
        <!-- ==================== Barre de Navigation ==================== -->
        <nav>
            <ul><li><strong>Dragon üêâ Registry</strong></li></ul>
            <ul>
                <li><a href="#" @click.prevent="changeView('explore')">Explorer</a></li>
                <li v-if="!isLoggedIn"><a href="#" role="button" class="contrast" @click.prevent="changeView('login')">Connexion</a></li>
                <li v-if="!isLoggedIn"><a href="#" role="button" @click.prevent="changeView('register')">S'inscrire</a></li>
                <li v-if="isLoggedIn"><a href="#" @click.prevent="changeView('profile')">Mon Profil</a></li>
                <li v-if="isLoggedIn"><a href="#" @click.prevent="logout">D√©connexion</a></li>
            </ul>
        </nav>

        <main>
            <!-- ==================== Vue d'Exploration et Recherche ==================== -->
            <section v-if="currentView === 'explore'">
                <h1>Explorer les paquets</h1>
                <input type="search" v-model="searchTerm" @input="searchPackages" placeholder="Rechercher un paquet...">
                <p v-if="isLoading">Chargement des paquets...</p>
                <div v-if="!isLoading && packages.length === 0">Aucun paquet trouv√©.</div>
                <div class="grid">
                    <article v-for="pkg in packages" :key="pkg.package_name + pkg.version">
                        <header>
                            <strong>{{ pkg.package_name }}</strong> @ <small>{{ pkg.version }}</small>
                        </header>
                        <p>{{ pkg.description }}</p>
                        <footer><small>Par : <em>{{ pkg.author }}</em></small></footer>
                    </article>
                </div>
            </section>

            <!-- ==================== Vue de Connexion ==================== -->
            <section v-if="currentView === 'login'">
                <article class="grid">
                    <div>
                        <hgroup>
                            <h1>Connexion</h1>
                            <h2>Acc√©dez √† votre compte Dragon.</h2>
                        </hgroup>
                        <form @submit.prevent="login">
                            <input type="email" v-model="loginForm.email" placeholder="Email" required>
                            <input type="password" v-model="loginForm.password" placeholder="Mot de passe" required>
                            <button type="submit" :aria-busy="isLoading">Se connecter</button>
                            <p v-if="error" class="error">{{ error }}</p>
                        </form>
                    </div>
                    <div></div>
                </article>
            </section>

            <!-- ==================== Vue d'Inscription ==================== -->
            <section v-if="currentView === 'register'">
                <article class="grid">
                    <div>
                        <hgroup>
                            <h1>Inscription</h1>
                            <h2>Cr√©ez un nouveau compte Dragon.</h2>
                        </hgroup>
                        <form @submit.prevent="register">
                            <input type="text" v-model="registerForm.username" placeholder="Nom d'utilisateur" required>
                            <input type="email" v-model="registerForm.email" placeholder="Email" required>
                            <input type="password" v-model="registerForm.password" placeholder="Mot de passe" required>
                            <button type="submit" :aria-busy="isLoading">S'inscrire</button>
                            <p v-if="error" class="error">{{ error }}</p>
                            <p v-if="successMessage">{{ successMessage }}</p>
                        </form>
                    </div>
                    <div></div>
                </article>
            </section>

            <!-- ==================== Vue du Profil Utilisateur ==================== -->
            <section v-if="currentView === 'profile'">
                <h1>Mon Profil</h1>
                <h3>Mes paquets publi√©s</h3>
                <p v-if="isLoading">Chargement de vos paquets...</p>
                <div v-if="!isLoading && userPackages.length === 0">Vous n'avez publi√© aucun paquet.</div>
                <ul>
                    <li v-for="pkg in userPackages">{{ pkg.package_name }} @ {{ pkg.version }}</li>
                </ul>

                <hr>

                <h3>Votre Cl√© API</h3>
                <p>Utilisez cette cl√© pour publier des paquets depuis votre CLI.</p>
                <button @click="generateApiKey" :aria-busy="isLoading">G√©n√©rer une nouvelle cl√© API</button>
                <div v-if="apiKey" class="api-key">
                    <code>{{ apiKey }}</code>
                </div>
            </section>
        </main>
    </div>

    <!-- 3. Le code de l'application Vue.js -->
    <script>
        const API_URL = "https://sarver-fullstack-4.onrender.com";

        const app = Vue.createApp({
            data() {
                return {
                    // √âtat global
                    currentView: 'explore',
                    isLoading: false,
                    error: null,
                    successMessage: null,
                    
                    // Donn√©es d'exploration
                    packages: [],
                    searchTerm: '',

                    // Donn√©es d'authentification
                    isLoggedIn: false,
                    token: null,
                    loginForm: { email: '', password: '' },
                    registerForm: { username: '', email: '', password: '' },

                    // Donn√©es utilisateur
                    userPackages: [],
                    apiKey: null,
                }
            },
            methods: {
                // --- Navigation ---
                changeView(view) {
                    this.currentView = view;
                    this.error = null; // R√©initialiser les erreurs en changeant de vue
                    this.successMessage = null;
                },

                // --- Logique des Paquets ---
                async fetchExplorePackages() {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`${API_URL}/packages/explore`);
                        this.packages = await response.json();
                    } catch (e) {
                        this.error = "Impossible de charger les paquets.";
                    } finally {
                        this.isLoading = false;
                    }
                },
                async searchPackages() {
                    if (this.searchTerm.trim() === '') {
                        this.fetchExplorePackages();
                        return;
                    }
                    this.isLoading = true;
                    try {
                        const response = await fetch(`${API_URL}/packages/search?q=${this.searchTerm}`);
                        this.packages = await response.json();
                    } catch (e) {
                        this.error = "La recherche a √©chou√©.";
                    } finally {
                        this.isLoading = false;
                    }
                },

                // --- Logique d'Authentification ---
                async register() {
                    this.isLoading = true;
                    this.error = null;
                    this.successMessage = null;
                    try {
                        const response = await fetch(`${API_URL}/auth/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.registerForm)
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error);
                        
                        this.successMessage = "Inscription r√©ussie ! Vous pouvez maintenant vous connecter.";
                        this.registerForm = { username: '', email: '', password: '' }; // Vider le formulaire
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.isLoading = false;
                    }
                },
                async login() {
                    this.isLoading = true;
                    this.error = null;
                    try {
                        const response = await fetch(`${API_URL}/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || "Email ou mot de passe invalide.");

                        this.token = data.token;
                        this.isLoggedIn = true;
                        localStorage.setItem('dragon_token', this.token); // Sauvegarder le token
                        this.changeView('profile');
                        this.fetchUserPackages(); // Charger les donn√©es du profil
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.isLoading = false;
                    }
                },
                logout() {
                    this.token = null;
                    this.isLoggedIn = false;
                    localStorage.removeItem('dragon_token');
                    this.changeView('explore');
                },

                // --- Logique du Profil ---
                async fetchUserPackages() {
                    if (!this.token) return;
                    this.isLoading = true;
                    try {
                        const response = await fetch(`${API_URL}/user/packages`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        this.userPackages = await response.json();
                    } catch (e) {
                        this.error = "Impossible de charger vos paquets.";
                    } finally {
                        this.isLoading = false;
                    }
                },
                async generateApiKey() {
                    if (!this.token) return;
                    this.isLoading = true;
                    try {
                        const response = await fetch(`${API_URL}/user/api-token`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        const data = await response.json();
                        this.apiKey = data.api_token;
                    } catch (e) {
                        this.error = "Impossible de g√©n√©rer la cl√© API.";
                    } finally {
                        this.isLoading = false;
                    }
                }
            },
            // --- Ex√©cut√© au chargement initial de la page ---
            mounted() {
                this.fetchExplorePackages();

                // V√©rifier si un token existe d√©j√† pour connecter l'utilisateur automatiquement
                const savedToken = localStorage.getItem('dragon_token');
                if (savedToken) {
                    this.token = savedToken;
                    this.isLoggedIn = true;
                    // On peut aussi aller directement au profil si on le souhaite
                    // this.changeView('profile');
                    // this.fetchUserPackages();
                }
            }
        });

        app.mount('#app');
    </script>

</body>
</html>
